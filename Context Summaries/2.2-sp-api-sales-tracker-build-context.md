# SP-API Sales Tracker - Build Context
**Last Updated:** February 4, 2026  
**Status:** Ready to Build (API tested, approach validated)

---

## Goal: Simple Daily Sales Tracker

Replicate your Google Sheets layout:
- **Rows:** ASINs (one per product)
- **Columns:** Monthly totals (Oct24, Nov24...) + Daily values (2/2, 1/2, 31/1...)

Store data in Supabase → Query for monthly aggregates and daily values.

---

## What We Validated (Postman Testing)

### ✅ Single-Day Reports Work
```
POST https://sellingpartnerapi-na.amazon.com/reports/2021-06-30/reports
{
  "reportType": "GET_SALES_AND_TRAFFIC_REPORT",
  "marketplaceIds": ["ATVPDKIKX0DER"],
  "dataStartTime": "2026-02-01T00:00:00Z",
  "dataEndTime": "2026-02-01T00:00:00Z",   ← SAME DATE = single day
  "reportOptions": {
    "dateGranularity": "DAY",
    "asinGranularity": "CHILD"
  }
}
```

**Result:** 195 ASINs, 680 units, $13,249.65 revenue for just Feb 1.

### ✅ Date Range Is Inclusive
- `startTime: Feb 1` + `endTime: Feb 2` = returns BOTH days
- Per-ASIN data is AGGREGATED across the range (not daily)
- **Solution:** Request one report per day (same start/end date)

### ❌ Data Kiosk API Failed
- Returns 401 "Access to requested resource is denied"
- May need additional role enablement in Seller Central
- **Workaround:** Use Reports API (proven to work)

---

## API Response Structure

```json
{
  "reportSpecification": {
    "dataStartTime": "2026-02-01",
    "dataEndTime": "2026-02-01"
  },
  "salesAndTrafficByDate": [
    {
      "date": "2026-02-01",
      "salesByDate": {
        "unitsOrdered": 680,
        "orderedProductSales": { "amount": 13249.65, "currencyCode": "USD" },
        "totalOrderItems": 512
      },
      "trafficByDate": {
        "sessions": 2450,
        "pageViews": 3200,
        "buyBoxPercentage": 98.5
      }
    }
  ],
  "salesAndTrafficByAsin": [
    {
      "parentAsin": "B09T6LJPGV",
      "childAsin": "B09T6LJPGV",
      "salesByAsin": {
        "unitsOrdered": 5,
        "unitsOrderedB2B": 0,
        "orderedProductSales": { "amount": 74.75, "currencyCode": "USD" },
        "orderedProductSalesB2B": { "amount": 0, "currencyCode": "USD" },
        "totalOrderItems": 4,
        "totalOrderItemsB2B": 0
      },
      "trafficByAsin": {
        "sessions": 45,
        "sessionsB2B": 2,
        "pageViews": 68,
        "pageViewsB2B": 3,
        "browserSessions": 30,
        "mobileAppSessions": 15,
        "browserPageViews": 45,
        "mobileAppPageViews": 23,
        "buyBoxPercentage": 99.2,
        "buyBoxPercentageB2B": 100,
        "unitSessionPercentage": 11.11,
        "unitSessionPercentageB2B": 0
      }
    }
  ]
}
```

---

## Supabase Table Design

### Option A: Store Everything (Recommended)
```sql
CREATE TABLE sp_daily_asin_data (
  id BIGSERIAL PRIMARY KEY,
  date DATE NOT NULL,
  marketplace_id TEXT NOT NULL,
  parent_asin TEXT,
  child_asin TEXT NOT NULL,
  
  -- Sales (store all fields API provides)
  units_ordered INTEGER DEFAULT 0,
  units_ordered_b2b INTEGER DEFAULT 0,
  ordered_product_sales DECIMAL(12,2) DEFAULT 0,
  ordered_product_sales_b2b DECIMAL(12,2) DEFAULT 0,
  currency_code TEXT DEFAULT 'USD',
  total_order_items INTEGER DEFAULT 0,
  total_order_items_b2b INTEGER DEFAULT 0,
  
  -- Traffic (store all fields API provides)
  sessions INTEGER DEFAULT 0,
  sessions_b2b INTEGER DEFAULT 0,
  page_views INTEGER DEFAULT 0,
  page_views_b2b INTEGER DEFAULT 0,
  browser_sessions INTEGER DEFAULT 0,
  mobile_app_sessions INTEGER DEFAULT 0,
  browser_page_views INTEGER DEFAULT 0,
  mobile_app_page_views INTEGER DEFAULT 0,
  buy_box_percentage DECIMAL(5,2),
  buy_box_percentage_b2b DECIMAL(5,2),
  unit_session_percentage DECIMAL(5,2),
  unit_session_percentage_b2b DECIMAL(5,2),
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(date, marketplace_id, child_asin)
);

-- Indexes for fast queries
CREATE INDEX idx_sp_daily_date ON sp_daily_asin_data(date DESC);
CREATE INDEX idx_sp_daily_asin ON sp_daily_asin_data(child_asin);
CREATE INDEX idx_sp_daily_marketplace ON sp_daily_asin_data(marketplace_id);
CREATE INDEX idx_sp_daily_date_marketplace ON sp_daily_asin_data(date, marketplace_id);
```

### Monthly Aggregates (SQL View or Query)
```sql
-- Get monthly totals per ASIN
SELECT 
  child_asin,
  DATE_TRUNC('month', date) AS month,
  SUM(units_ordered) AS monthly_units,
  SUM(ordered_product_sales) AS monthly_revenue
FROM sp_daily_asin_data
WHERE marketplace_id = 'ATVPDKIKX0DER'
GROUP BY child_asin, DATE_TRUNC('month', date)
ORDER BY month DESC, monthly_units DESC;
```

---

## Implementation Plan

### Phase 1: Manual Test Script (Python)
1. Authenticate with LWA
2. Request single-day report
3. Poll until complete
4. Download and parse JSON
5. Print summary

### Phase 2: Supabase Integration
1. Create table
2. Parse API response → insert rows
3. Test upsert for re-runs

### Phase 3: Automation (GitHub Actions)
1. Daily cron at 2 AM UTC
2. Pull data for (today - 2 days)
3. Loop through marketplaces
4. Store in Supabase

### Phase 4: Backfill Historical
1. Loop through past 730 days (2 years)
2. One report per day per marketplace
3. Handle rate limits (1 req/min for createReport)

---

## Credentials Needed

```env
# SP-API (Login With Amazon)
SP_LWA_CLIENT_ID=amzn1.application-oa2-client.xxxxx
SP_LWA_CLIENT_SECRET=xxxxx
SP_REFRESH_TOKEN_NA=Atzr|xxxxx

# Supabase
SUPABASE_URL=https://yawaopfqkkvdqtsagmng.supabase.co
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## Marketplace IDs

| Country | Marketplace ID | Region | Endpoint |
|---------|---------------|--------|----------|
| US | ATVPDKIKX0DER | NA | sellingpartnerapi-na.amazon.com |
| CA | A2EUQ1WTGCTBG2 | NA | sellingpartnerapi-na.amazon.com |
| UK | A1F83G8C2ARO7P | EU | sellingpartnerapi-eu.amazon.com |
| DE | A1PA6795UKMFR9 | EU | sellingpartnerapi-eu.amazon.com |
| FR | A13V1IB3VIYZZH | EU | sellingpartnerapi-eu.amazon.com |
| IT | APJ6JRA9NG5V4 | EU | sellingpartnerapi-eu.amazon.com |
| ES | A1RKKUPIHCS9HS | EU | sellingpartnerapi-eu.amazon.com |
| UAE | A2VIGQ35RCS4UG | EU | sellingpartnerapi-eu.amazon.com |
| AU | A39IBJ37TRP1C6 | FE | sellingpartnerapi-fe.amazon.com |
| JP | A1VC38T7YXB528 | FE | sellingpartnerapi-fe.amazon.com |

**Note:** Each region needs its own refresh token. Currently only NA is authorized.

---

## Rate Limits

| Operation | Rate | Notes |
|-----------|------|-------|
| createReport | ~1/min | Queue reports, don't spam |
| getReport | 2/sec | Fast polling OK |
| getReportDocument | ~1/min | Get URL, download immediately |

**For 10 marketplaces × 1 day:**
- 10 createReport calls = ~10 minutes
- Polling = negligible
- Downloads = ~10 minutes
- **Total: ~20-30 minutes per daily run**

---

## Files from Testing

| File | Description |
|------|-------------|
| `268ce8e4-...` | 7-day report (248 ASINs, aggregated) |
| `753b8710-...` | 2-day report (217 ASINs, Feb 1-2 aggregated) |
| `e069cc34-...` | 1-day report (195 ASINs, Feb 1 only) ✅ |

---

## Key Learnings

1. **Date range endpoints are INCLUSIVE** - Feb 1 to Feb 2 = both days
2. **Per-ASIN data aggregates across range** - no daily breakdown in multi-day reports
3. **Single-day reports give daily per-ASIN data** - this is the solution
4. **Reports are gzip compressed** - decompress before parsing
5. **Data Kiosk requires additional authorization** - Reports API works, use it
6. **Amazon data available ~34 hours after day ends** - pull "2 days ago"

---

## Recommended Approach for Claude Code

```
/sp-api-sales-tracker/
├── scripts/
│   └── pull_daily_sales.py      # Main script
├── .github/
│   └── workflows/
│       └── daily-pull.yml       # GitHub Actions cron
├── requirements.txt              # requests, supabase-py
├── .env.example                  # Template for credentials
└── README.md                     # Setup instructions
```

### Core Script Flow
```python
def main():
    # 1. Get access token
    access_token = refresh_access_token()
    
    # 2. For each marketplace
    for marketplace_id in MARKETPLACES:
        # 3. Request report for target_date
        report_id = create_report(access_token, marketplace_id, target_date)
        
        # 4. Poll until done
        doc_id = poll_until_done(access_token, report_id)
        
        # 5. Download and parse
        data = download_report(access_token, doc_id)
        
        # 6. Upsert to Supabase
        upsert_to_supabase(data, marketplace_id, target_date)
```

---

## Questions to Answer During Build

1. Should we store `salesAndTrafficByDate` (account-level daily totals) separately?
2. Do we need a products reference table to join with?
3. Should we track which dates have been pulled (pull_log table)?
4. How to handle EU/FE authorization (separate tokens)?

---

## Previous Transcripts

- `/mnt/transcripts/2026-02-04-10-25-29-sp-api-single-day-report-testing.txt` (this session)
- `/mnt/transcripts/2026-02-03-13-58-16-sp-api-sales-report-structure-analysis.txt`

---

## Ready to Build!

Start new chat or Claude Code session with this context document.

**First Step:** Create the Supabase table, then write Python script to pull one day of US data.
